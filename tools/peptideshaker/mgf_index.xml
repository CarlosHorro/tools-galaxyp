<tool id="mgf_index" name="Mgf Index" version="1.0">
    <description>
        Exports indexes from their mgf files
    </description>
    <macros>
        <import>macros_basic.xml</import>
    </macros>
    <requirements>
      <requirement type="package" version="@PEPTIDESHAKER_VERSION@">peptide-shaker</requirement>
    </requirements>
    <expand macro="stdio" />
    <command>
<![CDATA[
        #set $temp_stderr = "mgfindex_stderr"

        mkdir output_folder &&
        mkdir mgf_files &&
        mkdir temp &&
        cwd=`pwd` &&

        ## mgf file/s...
        #for $mgf in $input_mgf_files:
            #set $input_name = $mgf.element_identifier.split('/')[-1].replace(".mgf", "") + ".mgf"
            ln -s -f '${mgf}' \$cwd/mgf_files/'${input_name}' &&
            #set $encoded_id = $__app__.security.encode_id($mgf.id)
            echo 'Spectrums:${mgf.element_identifier}(API:${encoded_id})' &&
        #end for

        ###########################################
        ####         Creating indexes          ####
        ###########################################

        echo 'Creating index files...' &&

        (peptide-shaker -Djava.awt.headless=true eu.isas.peptideshaker.cmd.MgfIndexCLI
          -mgf_files "\$cwd/mgf_files"
          #if $zip_output_boolean == 'zip':
          -output_zip "\$cwd/output_folder/indexes.zip"
          #else:
          -output_folder "\$cwd/output_folder"
          #end if
          -temp_folder "\$cwd/temp"

          2>> $temp_stderr) &&

        cat $temp_stderr 2>&1;
]]>
    </command>
    <inputs>

        <param format="mgf" name="input_mgf_files" type="data" label="Mgf files" multiple="true"
            help="Select one or more Mascot (mgf) files from history"/>

        <param name="zip_output_boolean" type="boolean" truevalue="zip" falsevalue="separate"
          checked="false" label="Compress indexes into a single zip file" />

    </inputs>
    <outputs>
        <collection name="index_files" type="list" label="${tool.name} - indexes from ${on_string}" >
            <filter>zip_output_boolean is False</filter>
            <discover_datasets pattern="__name_and_ext__" directory="output_folder" ext="cui"/>
        </collection>

        <data name="compressed_index_files" format="zip" from_work_dir="output_folder/indexes.zip" label="${tool.name}: compressed indexes from ${on_string}">
            <filter>zip_output_boolean is True</filter>
        </data>
    </outputs>

    <tests>
        <test>
            <param name="input_mgf_files" value="searchgui_smallspectra.mgf" ftype="mgf"/>
            <output name="index_files" file="fastacli_searchgui_tinydb1_concatenated_target_decoy.fasta" ftype="mgf" compare="sim_size" delta="1000" />
        </test>
    </tests>

    <help>

**What it does**

Exports index files corresponding to input mgf files.

    </help>
    <expand macro="citations" />
</tool>
