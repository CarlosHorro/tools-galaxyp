<tool id="metaquantome_expand" name="metaQuantome: expand" version="@GVERSION@">
  <description>annotated functional or taxonomy terms to include all terms</description>
  <macros>
    <import>macros.xml</import>
    <xml name="FUNC_FILE">
      <param argument="--func_file" type="data" format="tabular" label="Functional file"
          help="Tabular file with a peptide sequence column and a functional assignment column for GO-term, EC number, or COG."/>
      <param argument="--pep_colname_func" type="text" label="Peptide column name"
          help="The column name within the function file that corresponds to the peptide sequences">
          <validator type="empty_field"/>
      </param>
    </xml>
    <xml name="FUNC_COLNAME">
      <param argument="--func_colname" type="text" label="Functional column name"
          help="The column name within the function file with the functional terms">
          <validator type="empty_field"/>
      </param>
    </xml>
    <xml name="TAX_FILE">
      <param argument="--tax_file" type="data" format="tabular" label="Taxonomy assignments file"/>
      <param argument="--pep_colname_tax" type="text" label="Peptide column name"
          help="The column name within the taxonomy file that corresponds to the peptide sequences">
          <validator type="empty_field"/>
      </param>
    </xml>
    <xml name="TAX_COLNAME">
      <param argument="--tax_colname" type="text" label="Taxonomy column name">
          <help>
              Name of taxonomy column in taxonomy assignments file. The column must
              be either NCBI taxids (strongly preferred) or taxonomy
              names. Unipept name output is known to function well,
              but other formats may not work.
          </help>
          <validator type="empty_field"/>
      </param>
    </xml>
    <xml name="FT_TAR_RANK">
      <param argument="--ft_tar_rank" type="select" label="rank at which to group taxonomy">
        <option value="species">species</option>
        <option value="genus" selected="true">genus</option>
        <option value="family">family</option>
        <option value="order">order</option>
        <option value="class">class</option>
        <option value="phylum">phylum</option>
        <option value="kingdom">kingdom</option>
      </param>
    </xml>
    <token name="@FUNC_FILE@">
      --func_file='$input.mode_args.func_file'
      --pep_colname_func='$input.mode_args.pep_colname_func'
    </token>
    <token name="@FUNC_COLNAME@">
      --func_colname='$input.mode_args.func_colname'
    </token>
    <token name="@ONTOLOGY@">
      --ontology='$input.mode_args.ontology_args.ontology'
      #if $input.mode_args.ontology_args.ontology == 'go'
          #if $input.mode_args.ontology_args.slim_down
              --slim_down
          #end if
      #end if
    </token>
    <token name="@TAX_FILE@">
      --tax_file='$input.mode_args.tax_file'
      --pep_colname_tax='$input.mode_args.pep_colname_tax'
    </token>
    <token name="@TAX_COLNAME">
      --tax_colname='$input.mode_args.tax_colname'
    </token>
    <token name="@FT_TAR_RANK@">
      --ft_tar_rank='$input.mode_args.ft_tar_rank'
    </token>
  </macros>
  <expand macro="requirements" />
  <command detect_errors="exit_code"><![CDATA[
    tar -xf $db_tar &&
    metaquantome expand
    --data_dir ./data
    --samps '$samps'
    --mode '$input.mode_args.mode'
    #if $input.input_type == 'pep':
      --int_file='$input.int_file'
      --pep_colname_int='$input.pep_colname_int'
      #if $input.mode_args.mode == 'f'
        @FUNC_FILE@
        @FUNC_COLNAME@
        @ONTOLOGY@
      #elif $input.mode_args.mode =='t'
        @TAX_FILE@
        @TAX_COLNAME@
      #elif $input.mode_args.mode == 'ft'
        @FUNC_FILE@
        @FUNC_COLNAME@
        @ONTOLOGY@
        @TAX_FILE@
        @TAX_COLNAME@
        @FT_TAR_RANK@
      #end if
    #else
      --nopep --nopep_file='$input.nopep_file'
      #if $input.mode_args.mode == 'f'
        @FUNC_COLNAME@
        @ONTOLOGY@
      #elif $input.mode_args.mode == 't'
        @TAX_COLNAME@
      #elif $input.mode_args.mode == 'ft'
        @FUNC_COLNAME@
        @ONTOLOGY@
        @TAX_COLNAME@
        @FT_TAR_RANK@
      #end if
    #end if
    --outfile='$outfile'
  ]]></command>
  <inputs>
    <param name="db_tar" type="data" format="tar" label="Database Archive File"
      help="must be created by 'metaQuantome: download'"/>
    <expand macro="SAMPS"/>
    <conditional name="input">
      <param name="input_type" type="select" label="Input files">
        <option value="pep" selected="true">separate files with peptide column</option>
        <option value="nopep">one prejoined file without a peptide column</option>
      </param>
      <when value="pep">
        <param argument="--int_file" type="data" format="tabular" label="intensity data"
          help=""/>
        <param argument="--pep_colname_int" type="text" value="" label="Peptide column name"
          help="The column name within the intensity file that corresponds to the peptide sequences">
          <validator type="empty_field"/>
        </param>
        <conditional name="mode_args">
          <param argument="--mode" type="select" label="Mode">
            <option value="f">Functional analysis</option>
            <option value="t">Taxonomic analysis</option>
            <option value="ft">Functional-taxonomic interaction analysis</option>
          </param>
          <when value="f">
            <expand macro="FUNC_FILE"/>
            <expand macro="FUNC_COLNAME"/>
            <expand macro="ONTOLOGY_ARGS"/>
          </when>
          <when value="t">
            <expand macro="TAX_FILE"/>
            <expand macro="TAX_COLNAME"/>
          </when>
          <when value="ft">
            <expand macro="FUNC_FILE"/>
            <expand macro="FUNC_COLNAME"/>
            <expand macro="ONTOLOGY_ARGS"/>
            <expand macro="TAX_FILE"/>
            <expand macro="TAX_COLNAME"/>
            <expand macro="FT_TAR_RANK"/>
          </when>
        </conditional>
      </when>
      <when value="nopep">
        <conditional name="mode_args">
          <param argument="--mode" type="select" label="Mode">
            <option value="f">Functional analysis</option>
            <option value="t">Taxonomic analysis</option>
            <option value="ft">Functional-taxonomic interaction analysis</option>
          </param>
          <when value="f">
            <expand macro="ONTOLOGY_ARGS"/>
            <expand macro="FUNC_COLNAME"/>
          </when>
          <when value="t">
            <expand macro="TAX_COLNAME"/>
          </when>
          <when value="ft">
            <expand macro="ONTOLOGY_ARGS"/>
            <expand macro="FUNC_COLNAME"/>
            <expand macro="TAX_COLNAME"/>
            <expand macro="FT_TAR_RANK"/>
          </when>
        </conditional>
      </when>
    </conditional>
  </inputs>
  <outputs>
      <data format="tabular" name="outfile" label="${tool.name} on ${on_string} expanded"/>
  </outputs>
  <tests>
    <test>
       <param name="db_tar" value="ec.tar" ftype="tar"/>
       <param name="samps" value="samples_basic.tab" ftype="tabular"/>
       <param name="input_type" value="pep"/>
       <param name="int_file" value="int_ttest.tab" ftype="tabular"/>
       <param name="pep_colname_int" value="peptide" />
       <param name="func_file" value="multiple_func.tab" />
       <param name="pep_colname_func" value="peptide" />
       <param name="func_colname" value="ec"/>
       <param name="mode" value="f" />
       <param name="ontology" value="ec" />
       <output name="outfile">
         <assert_contents>
           <has_text text="1.2.7.10"/>
         </assert_contents>
       </output>
    </test>
  </tests>
  <help>
<![CDATA[
metaQuantome expand
===================

The *expand* module is the first step in the metaQuantome analysis workflow,
and can be run to analyze function, taxonomy, or function and taxonomy together.

Typically, the analyis workflow is expand, filter, stat, viz (for differential expression), or expand, filter, viz (for other analyses).


The following information is required for all 3 analysis modes.

- experimental design information
- a tab-separated peptide intensity file
- the name of the peptide column in the intensity file

Function mode
-------------

In function mode, the following information is required:

- the ontology being used: Gene Ontology (go), Clusters of Orthologous Groups (COG), or Enzyme Commission (EC) numbers.
- a tab-separated functional annotation file, with a peptide column and a functional annotation column. An entry in the functional annotation column may contain multiple functional annotations separated by a comma.
- the name of the peptide column in the functional annotation file
- the name of the functional annotation column in the functional annotation file

Taxonomy mode
-------------

In taxonomy mode, the following information is required:

- a tab-separated taxonomy annotation file, with a peptide column and a taxonomy annotation column. The taxonomic annotations should be the lowest common ancestor (LCA) for each peptide, preferably given as NCBI taxonomy IDs.
- the name of the peptide column in the taxonomic annotation file
- the name of the taxonomy annotation column in the taxonomy annotation file

Function-Taxonomy mode
----------------------

In the combined mode, all of the above must be provided. In addition, the "target rank" must be provided, which is the desired taxonomic rank at which to summarize the function/taxonomy results.

Databases
---------

Currently, metaQuantome on Galaxy is only set up to use automatically downloaded databases, so your results may change slightly from run to run. In the future, we plan to enable cached databases in Galaxy.

Questions, Comments, Problems, Kudos
------------------------------------

Please file any issues at https://github.com/galaxyproteomics/tools-galaxyp/issues.`
]]></help>
  <expand macro="citations" />
</tool>
