<tool id="metaquantome_expand" name="metaQuantome: expand" version="@GVERSION@">
    <description>annotated functional or taxonomy terms to include all terms</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        tar -xf $db_tar &&
        metaquantome expand
        --data_dir ./data
        --samps '$samps'
        --mode '$mode_args.mode'
        #if $mode_args.mode == 'f'
            --func_file='$mode_args.func_file'
            --func_colname='$mode_args.func_colname'
            --pep_colname_func='$mode_args.pep_colname_func'
            --ontology='$mode_args.ontology_args.ontology'
            #if $mode_args.ontology_args.ontology == 'go'
                #if $mode_args.ontology_args.slim_down
                    --slim_down
                #end if
            #end if
        #end if
        #if $mode_args.mode =='t'
            --tax_file='$mode_args.tax_file'
            --tax_colname='$mode_args.tax_colname'
            --pep_colname_tax='$mode_args.pep_colname_tax'
        #end if
        #if $mode_args.mode == 'ft'
            --func_file='$mode_args.func_file'
            --func_colname='$mode_args.func_colname'
            --pep_colname_func='$mode_args.pep_colname_func'
            --ontology='$mode_args.ontology_args.ontology'
            #if $mode_args.ontology_args.ontology == 'go'
                #if $mode_args.ontology_args.slim_down
                    --slim_down
                #end if
            #end if
            --tax_file='$mode_args.tax_file'
            --tax_colname='$mode_args.tax_colname'
            --pep_colname_tax='$mode_args.pep_colname_tax'
            --ft_tar_rank='$mode_args.ft_tar_rank'
        #end if
        #if $input.input_type == 'nopep':
            --nopep --nopep_file='$input.nopep_file'
        #else:
            --int_file='$input.int_file'
            --pep_colname_int='$input.pep_colname_int'
        #end if
       --outfile='$outfile'
    ]]></command>
    <inputs>
        <param name="db_tar" type="data" format="tar" label="Database Archive File"
          help="must be created by 'metaQuantome: download'"/>
        <expand macro="SAMPS"/>
        <conditional name="mode_args">
            <param argument="--mode" type="select" label="Mode">
                <option value="f">Functional analysis</option>
                <option value="t">Taxonomic analysis</option>
                <option value="ft">Functional-taxonomic interaction analysis</option>
            </param>
            <when value="f">
                <expand macro="FUNC_FILE"/>
                <expand macro="ONTOLOGY_ARGS"/>
            </when>
            <when value="t">
                <expand macro="TAX_FILE"/>
            </when>
            <when value="ft">
                <expand macro="FUNC_FILE"/>
                <expand macro="ONTOLOGY_ARGS"/>
                <expand macro="TAX_FILE"/>
                <param argument="--ft_tar_rank" type="select" label="rank at which to group taxonomy">
                    <option value="species">species</option>
                    <option value="genus" selected="true">genus</option>
                    <option value="family">family</option>
                    <option value="order">order</option>
                    <option value="class">class</option>
                    <option value="phylum">phylum</option>
                    <option value="kingdom">kingdom</option>
                </param>
            </when>
        </conditional>
        <conditional name="input">
            <param name="input_type" type="select" label="Select input data">
                <option value="int">tabular intensity file with peptide column</option>
                <option value="nopep">file without a peptide column</option>
            </param>
            <when value="int">
                <param argument="--int_file" type="data" format="tabular" label="intensity data"
                    help=""/>
                <param argument="--pep_colname_int" type="text" value="" label="Peptide column name"
                    help="The column name within the intensity file that corresponds to the peptide sequences">
                    <validator type="empty_field"/>
                </param>
            </when>
            <when value="nopep">
                <param argument="--nopep_file" type="data" format="tabular" label="intensity data"
                    help=""/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="tabular" name="outfile" label="${tool.name} on ${on_string} expanded"/>
        <expand macro="output_samples"/>
    </outputs>
    <tests>
        <test>
             <param name="db_tar" value="ec.tar" ftype="tar"/>
             <param name="samps" value="samples_basic.tab" ftype="tabular"/>
             <param name="int_file" value="int_ttest.tab" ftype="tabular"/>
             <param name="pep_colname_int" value="peptide" />
             <param name="func_file" value="multiple_func.tab" />
             <param name="pep_colname_func" value="peptide" />
             <param name="func_colname" value="ec"/>
             <param name="mode" value="f" />
             <param name="ontology" value="ec" />
             <output name="outfile">
               <assert_contents>
                 <has_text text="1.2.7.10"/>
               </assert_contents>
             </output>
        </test>
    </tests>
    <help>
<![CDATA[
metaQuantome expand
===================

The *expand* module is the first step in the metaQuantome analysis workflow,
and can be run to analyze function, taxonomy, or function and taxonomy together.

Typically, the analyis workflow is expand, filter, stat, viz (for differential expression), or expand, filter, viz (for other analyses).


The following information is required for all 3 analysis modes.

- experimental design information
- a tab-separated peptide intensity file
- the name of the peptide column in the intensity file

Function mode
-------------

In function mode, the following information is required:

- the ontology being used: Gene Ontology (go), Clusters of Orthologous Groups (COG), or Enzyme Commission (EC) numbers.
- a tab-separated functional annotation file, with a peptide column and a functional annotation column. An entry in the functional annotation column may contain multiple functional annotations separated by a comma.
- the name of the peptide column in the functional annotation file
- the name of the functional annotation column in the functional annotation file

Taxonomy mode
-------------

In taxonomy mode, the following information is required:

- a tab-separated taxonomy annotation file, with a peptide column and a taxonomy annotation column. The taxonomic annotations should be the lowest common ancestor (LCA) for each peptide, preferably given as NCBI taxonomy IDs.
- the name of the peptide column in the taxonomic annotation file
- the name of the taxonomy annotation column in the taxonomy annotation file

Function-Taxonomy mode
----------------------

In the combined mode, all of the above must be provided. In addition, the "target rank" must be provided, which is the desired taxonomic rank at which to summarize the function/taxonomy results.

Databases
---------

Currently, metaQuantome on Galaxy is only set up to use automatically downloaded databases, so your results may change slightly from run to run. In the future, we plan to enable cached databases in Galaxy.

Questions, Comments, Problems, Kudos
------------------------------------

Please file any issues at https://github.com/galaxyproteomics/tools-galaxyp/issues.`
]]></help>
    <expand macro="citations" />
</tool>
