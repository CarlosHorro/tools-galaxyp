<tool id="flashlfq" name="FlashLFQ" version="0.1.0">
    <description>ultrafast label-free quantification for mass-spectrometry proteomics</description>
    <requirements>
        <requirement type="package" version="0.1.99">flashlfq</requirement>
    </requirements>
    <command><![CDATA[
        #import re
        #set $idt_path = $re.sub('[.][^.]*$','',$idt.display_name.split('/')[-1]) + ".psmtsv"
        ## cp '${idt}' '${idt_path}';
        ln -s '${idt}' '${idt_path}';
        #for $peak_list in $peak_lists:
            #set $input_name = $re.sub('[.][^.]*$','',$peak_list.display_name.split('/')[-1]) + ".mzML"
            ln -s '${peak_list}' '${input_name}';
        #end for
        FlashLFQ --idt $idt_path --rep `pwd` --ppm $ppm --iso $iso --nis $nis
        #if $intensity == 'integrate':
        --int true
        #end if
        #if $charge == 'precursor':
        --chg true
        #end if
        $rmm $mbr
        --pau false
        && cat *_FlashLFQ_Log.txt | sed 's/\(Analysis summary for:\).*working./\1 /' > '$log' 
        && cp *_FlashLFQ_QuantifiedBaseSequences.tsv '$quantifiedBaseSequences'
        && cp *_FlashLFQ_QuantifiedModifiedSequences.tsv '$quantifiedModifiedSequences'
        && cp *_FlashLFQ_QuantifiedPeaks.tsv '$quantifiedPeaks'
        && cp *_FlashLFQ_QuantifiedProteins.tsv '$quantifiedProteins'
    ]]></command>
    <inputs>
        <param name="idt" type="data" format="tabular" label="identification file"/>
        <param name="peak_lists" type="data" format="mzml" multiple="true" label="spectrum files"/>
        <param name="ppm" type="float" value="10" min="1" max="20" label="monoisotopic ppm tolerance"/>
        <param name="iso" type="float" value="5" min="1" max="10" label="isotopic distribution tolerance in ppm"/>
        <param name="nis" type="integer" value="2" min="1" max="30" label="number of isotopes required to be observed"/>
        <param name="intensity" type="select" label="intensity">
            <option value="apex" selected="true">use the apex intensity</option>
            <option value="integrate">integrate chromatographic peak intensity</option>
        </param>
        <param name="charge" type="select" label="charge">
            <option value="all" selected="true">use all identification detected charge states</option>
            <option value="precursor">use precursor charge</option>
        </param>
        <param name="rmm" type="boolean" truevalue="--rmm true" falsevalue="--rmm false" checked="true" 
            label="require observed monoisotopic mass peak"/>
        <param name="mbr" type="boolean" truevalue="--mbr true" falsevalue="--mbr false" checked="false" 
            label="match between runs"/>
    </inputs>
    <outputs>
        <data name="log" format="txt" label="${tool.name} on ${on_string}: Log" />
        <data name="quantifiedBaseSequences" format="tabular" label="${tool.name} on ${on_string}: QuantifiedBaseSequences.tsv" />
        <data name="quantifiedModifiedSequences" format="tabular" label="${tool.name} on ${on_string}: QuantifiedModifiedSequences.tsv" />
        <data name="quantifiedPeaks" format="tabular" label="${tool.name} on ${on_string}: QuantifiedPeaks.tsv" />
        <data name="quantifiedProteins" format="tabular" label="${tool.name} on ${on_string}: QuantifiedProteins.tsv" />
    </outputs>
    <tests>
        <test>
            <param name="idt" value="aggregatePSMs_5ppmAroundZero.psmtsv" ftype="tabular"/>
            <param name="scans" value="sliced-mzml.mzML" ftype="mzml"/>
            <param name="ppm" value="12"/>
            <param name="iso" value="6"/>
            <output name="log">
                <assert_contents>
                    <has_text text="ppmTolerance = 12" />
                    <has_text text="isotopePpmTolerance = 6" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

**FlashLFQ** 

**Accepted command-line arguments:**

::

    --idt [string | identification file path (TSV format)]
    --raw [string | MS data file (.raw or .mzML)]
    --rep [string | repository containing MS data files]
    --ppm [double | monoisotopic ppm tolerance] (default = 10)
    --iso [double | isotopic distribution tolerance in ppm] (default = 5)
    --sil [boolean | silent mode; no console output] (default = false)
    --pau [boolean | pause at end of run] (default = true)
    --int [boolean | integrate chromatographic peak intensity instead of using 
          the apex intensity] (default = false)
    --chg [boolean | use only precursor charge state; when set to false, FlashLFQ looks 
          for all charge states detected in the MS/MS identification file for each peptide] (default = false)
    --mbr [bool|match between runs]
    --rmm [bool|require observed monoisotopic mass peak]
    --nis [int|number of isotopes required to be observed]


    ]]></help>
    <citations>
        <citation type="doi">10.1021/acs.jproteome.7b00608</citation>
    </citations>
</tool>
